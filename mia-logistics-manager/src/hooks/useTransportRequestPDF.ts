import { useState, useCallback } from 'react';
import {
  TransportRequestPDFService,
  TransportRequestPDFData,
} from '@/services/pdf/transportRequestPDFService';
import type { TransportRequest } from '@/features/shipments/components/TransportRequestsSheet';

export const useTransportRequestPDF = () => {
  const [isGenerating, setIsGenerating] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // H√†m t·∫°o d·ªØ li·ªáu c√°c ƒëi·ªÉm d·ª´ng - ch·ªâ t·∫°o d√≤ng cho c√°c ƒëi·ªÉm c√≥ d·ªØ li·ªáu
  // H√†m r√∫t g·ªçn ƒë·ªãa ch·ªâ - lo·∫°i b·ªè "Th√†nh ph·ªë/T·ªânh"
  const shortenAddress = useCallback((address: string): string => {
    if (!address) return '';

    // Lo·∫°i b·ªè c√°c t·ª´ cu·ªëi nh∆∞ "Th√†nh ph·ªë H·ªì Ch√≠ Minh", "T·ªânh B√¨nh D∆∞∆°ng", etc.
    const cityPatterns = [
      /,\s*Th√†nh ph·ªë\s+[^,]+$/i,
      /,\s*T·ªânh\s+[^,]+$/i,
      /,\s*TP\s+[^,]+$/i,
      /,\s*Tp\s+[^,]+$/i,
    ];

    let shortenedAddress = address;
    for (const pattern of cityPatterns) {
      shortenedAddress = shortenedAddress.replace(pattern, '');
    }

    return shortenedAddress.trim();
  }, []);

  const generateStopsData = useCallback(
    (transportRequest: TransportRequest) => {
      console.log('=== generateStopsData called ===');
      console.log('transportRequest:', transportRequest);

      // Debug: Ki·ªÉm tra d·ªØ li·ªáu MN t·ª´ sheet
      console.log('üîç MN Data from sheet:');
      for (let i = 1; i <= 10; i++) {
        const mnKey = `stop${i}MN` as keyof TransportRequest;
        const mnValue = transportRequest[mnKey];
        console.log(
          `  ${mnKey}: "${mnValue || 'null/undefined'}" (type: ${typeof mnValue})`
        );
      }

      // Debug: Ki·ªÉm tra d·ªØ li·ªáu ƒëi·ªÉm d·ª´ng t·ª´ sheet
      console.log('üîç Stop Data from sheet:');
      for (let i = 1; i <= 10; i++) {
        const addressKey = `stop${i}Address` as keyof TransportRequest;
        const productsKey = `stop${i}Products` as keyof TransportRequest;
        const packagesKey = `stop${i}Packages` as keyof TransportRequest;
        const volumeKey = `stop${i}VolumeM3` as keyof TransportRequest;

        console.log(`  Stop ${i}:`, {
          address: transportRequest[addressKey] || 'null/undefined',
          products: transportRequest[productsKey] || 'null/undefined',
          packages: transportRequest[packagesKey] || 'null/undefined',
          volume: transportRequest[volumeKey] || 'null/undefined',
        });
      }
      const stops = [];
      const stopData = [
        {
          mn: transportRequest.stop1MN || '',
          address: transportRequest.stop1Address,
          orderCount: transportRequest.stop1OrderCount || 0,
          packages: transportRequest.stop1Packages,
          volume: transportRequest.stop1VolumeM3,
        },
        {
          mn: transportRequest.stop2MN || '',
          address: transportRequest.stop2Address,
          orderCount: transportRequest.stop2OrderCount || 0,
          packages: transportRequest.stop2Packages,
          volume: transportRequest.stop2VolumeM3,
        },
        {
          mn: transportRequest.stop3MN || '',
          address: transportRequest.stop3Address,
          orderCount: transportRequest.stop3OrderCount || 0,
          packages: transportRequest.stop3Packages,
          volume: transportRequest.stop3VolumeM3,
        },
        {
          mn: transportRequest.stop4MN || '',
          address: transportRequest.stop4Address,
          orderCount: transportRequest.stop4OrderCount || 0,
          packages: transportRequest.stop4Packages,
          volume: transportRequest.stop4VolumeM3,
        },
        {
          mn: transportRequest.stop5MN || '',
          address: transportRequest.stop5Address,
          orderCount: transportRequest.stop5OrderCount || 0,
          packages: transportRequest.stop5Packages,
          volume: transportRequest.stop5VolumeM3,
        },
        {
          mn: transportRequest.stop6MN || '',
          address: transportRequest.stop6Address,
          orderCount: transportRequest.stop6OrderCount || 0,
          packages: transportRequest.stop6Packages,
          volume: transportRequest.stop6VolumeM3,
        },
        {
          mn: transportRequest.stop7MN || '',
          address: transportRequest.stop7Address,
          orderCount: transportRequest.stop7OrderCount || 0,
          packages: transportRequest.stop7Packages,
          volume: transportRequest.stop7VolumeM3,
        },
        {
          mn: transportRequest.stop8MN || '',
          address: transportRequest.stop8Address,
          orderCount: transportRequest.stop8OrderCount || 0,
          packages: transportRequest.stop8Packages,
          volume: transportRequest.stop8VolumeM3,
        },
        {
          mn: transportRequest.stop9MN || '',
          address: transportRequest.stop9Address,
          orderCount: transportRequest.stop9OrderCount || 0,
          packages: transportRequest.stop9Packages,
          volume: transportRequest.stop9VolumeM3,
        },
        {
          mn: transportRequest.stop10MN || '',
          address: transportRequest.stop10Address,
          orderCount: transportRequest.stop10OrderCount || 0,
          packages: transportRequest.stop10Packages,
          volume: transportRequest.stop10VolumeM3,
        },
      ];

      let stt = 1;
      for (const stop of stopData) {
        // Debug: Log d·ªØ li·ªáu ƒë·ªÉ ki·ªÉm tra
        console.log('Checking stop:', stop.mn, {
          address: stop.address,
          orderCount: stop.orderCount,
          packages: stop.packages,
          volume: stop.volume,
        });

        // Ch·ªâ t·∫°o d√≤ng n·∫øu c√≥ √≠t nh·∫•t 1 trong c√°c tr∆∞·ªùng: address, orderCount, packages, volume
        // MN c√≥ th·ªÉ r·ªóng (hi·ªÉn th·ªã d·∫•u g·∫°ch ngang)
        if (stop.address || stop.orderCount || stop.packages || stop.volume) {
          console.log('Adding stop:', stop.mn, 'with STT:', stt);
          stops.push({
            stt: stt++,
            mn: stop.mn || '-', // Hi·ªÉn th·ªã d·∫•u g·∫°ch ngang n·∫øu MN r·ªóng
            address: shortenAddress(stop.address || ''),
            pck: stop.orderCount || 0, // S·ª≠ d·ª•ng orderCount thay v√¨ products
            packages: stop.packages || 0,
            volume: stop.volume || 0,
            confirmed: false,
          });
        }
      }

      console.log('Total stops generated:', stops.length);

      // Debug: Ki·ªÉm tra k·∫øt qu·∫£ cu·ªëi c√πng
      console.log('üîç Final stops data:');
      stops.forEach((stop, index) => {
        console.log(
          `  Stop ${index + 1}: STT=${stop.stt}, MN=${stop.mn}, Address=${stop.address}`
        );
      });

      return stops;
    },
    [shortenAddress]
  );

  const generatePDF = useCallback(
    async (transportRequest: TransportRequest) => {
      console.log('=== generatePDF called ===');
      console.log('transportRequest received:', transportRequest);
      setIsGenerating(true);
      setError(null);

      try {
        const pdfService = new TransportRequestPDFService();

        // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu t·ª´ TransportRequest sang TransportRequestPDFData
        // T·∫°o base64 cho logo - s·ª≠ d·ª•ng import tr·ª±c ti·∫øp
        let logoBase64 = '';
        try {
          // Import h√¨nh ·∫£nh tr·ª±c ti·∫øp t·ª´ th∆∞ m·ª•c public
          const response = await fetch('/images/image1.png');
          const blob = await response.blob();
          const reader = new FileReader();
          logoBase64 = await new Promise((resolve) => {
            reader.onload = () => {
              // Ch·ªâ l·∫•y ph·∫ßn base64, kh√¥ng c·∫ßn data:image/png;base64,
              const result = reader.result as string;
              const base64Part = result.split(',')[1]; // L·∫•y ph·∫ßn sau d·∫•u ph·∫©y
              resolve(base64Part);
            };
            reader.readAsDataURL(blob);
          });
        } catch {
          console.warn('Kh√¥ng th·ªÉ load logo, s·ª≠ d·ª•ng placeholder');
          logoBase64 =
            'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
        }

        // T·∫°o m√£ requestCode v·ªõi format MSC-...
        const requestCode = transportRequest.requestCode || `MSC-${Date.now()}`;

        // T·∫°o d·ªØ li·ªáu c√°c ƒëi·ªÉm d·ª´ng tr∆∞·ªõc
        const stopsData = generateStopsData(transportRequest);
        console.log('üîç Generated stops data:', stopsData);

        const pdfData: TransportRequestPDFData = {
          requestId: transportRequest.requestId || '',
          requestCode: requestCode,
          createdAt: transportRequest.createdAt || new Date().toISOString(),
          vehicleType: transportRequest.vehicleType || '',
          pickupAddress: transportRequest.pickupAddress || '',
          totalVolumeM3: transportRequest.totalVolumeM3 || 0,
          totalPackages: transportRequest.totalPackages || 0,
          totalOrders: transportRequest.totalOrderCount || 0,
          logoBase64: logoBase64,

          // T·∫°o d·ªØ li·ªáu c√°c ƒëi·ªÉm d·ª´ng - ch·ªâ t·∫°o d√≤ng cho c√°c ƒëi·ªÉm c√≥ d·ªØ li·ªáu
          stops: stopsData,

          // Th√¥ng tin nh√¢n vi√™n
          employeeName: transportRequest.department || 'Minh Tr√≠', // L·∫•y t·ª´ department ho·∫∑c default
          carrierName: transportRequest.carrierName || 'Minh Tr√≠', // L·∫•y t·ª´ carrierName ho·∫∑c default
          warehouseManager: 'L∆∞u Danh Thi√™n T·ª≠', // Gi·ªØ nguy√™n nh∆∞ template g·ªëc
        };

        console.log('üîç Final PDF data:', pdfData);

        const html = await pdfService.generatePDF(pdfData);

        // T·∫°o m·ªôt c·ª≠a s·ªï m·ªõi v·ªõi HTML v√† m·ªü print dialog
        const printWindow = window.open('', '_blank');
        if (printWindow) {
          printWindow.document.write(html);
          printWindow.document.close();

          // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ HTML load xong r·ªìi m·ªü print dialog
          setTimeout(() => {
            printWindow.print();
            // ƒê√≥ng c·ª≠a s·ªï sau khi in
            setTimeout(() => {
              printWindow.close();
            }, 1000);
          }, 500);
        } else {
          throw new Error('Kh√¥ng th·ªÉ m·ªü c·ª≠a s·ªï in');
        }

        return html;
      } catch (err) {
        const errorMessage =
          err instanceof Error ? err.message : 'L·ªói kh√¥ng x√°c ƒë·ªãnh khi t·∫°o PDF';
        setError(errorMessage);
        throw err;
      } finally {
        setIsGenerating(false);
      }
    },
    [generateStopsData]
  );

  return {
    generatePDF,
    isGenerating,
    error,
    clearError: () => setError(null),
  };
};
